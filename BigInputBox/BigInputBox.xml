<Ui xmlns="http://www.blizzard.com/wow/ui/">

	<Frame name="BigInputBox" parent="UIParent" toplevel="true" hidden="true" frameStrata="FULLSCREEN" frameLevel="5" ignoreParentScale="true" scale="0.71111111111111">
		<Size x="440" y="42"/>
		<Anchors>
			<Anchor point="BOTTOM" x="0" y="330"/>
		</Anchors>
		<Scripts>
			<OnLoad>
				local db = IsAddOnLoaded("BigInputBox") and BigInputBox_DB;
				if (db) and (db.point) and (db.offsetX) and (db.offsetX) then
					self:ClearAllPoints();
					self:SetPoint(db.point, db.offsetX, db.offsetY);
				else
					self:RegisterEvent("ADDON_LOADED");
				end
			</OnLoad>
			<OnEvent>
				if (event == "ADDON_LOADED") then
					local addon = ...;
					if (addon == "BigInputBox") then
						local db = BigInputBox_DB;
						if (db) and (db.point) and (db.offsetX) and (db.offsetX) then
							self:ClearAllPoints();
							self:SetPoint(BigInputBox_DB.point, BigInputBox_DB.offsetX, BigInputBox_DB.offsetY);
						end
					end
				end
			</OnEvent>
		</Scripts>
		<Frames>
			<Frame parentKey="uiHider" hidden="true" />
			<EditBox name="$parentEditBox" inherits="ChatFrameEditBoxTemplate" parentKey="editBox" frameStrata="FULLSCREEN" frameLevel="6" autoFocus="true" ignoreArrows="false" multiLine="false" toplevel="false" hidden="true">
				<Size x="408" y="22"/>
				<Anchors>
					<Anchor point="CENTER"/>
				</Anchors>
				<Frames>
					<!-- Add an unused backdrop frame to avoid ElvUI and the likes putting double borders on our box. -->
					<Frame mixin="BigInputBoxBackdropTemplateMixin" parentKey="backdrop" hidden="true" />
					<Frame name="$parentBackdrop" mixin="BigInputBoxBackdropTemplateMixin" parentKey="Backdrop" frameStrata="FULLSCREEN" frameLevel="5">
						<Anchors>
							<Anchor point="TOPLEFT" x="-34" y="30"/>
							<Anchor point="BOTTOMRIGHT" x="34" y="-30"/>
						</Anchors>
						<Scripts>
							<OnLoad>
								self:SetBackdrop({ 
									bgFile = [[Interface\ChatFrame\ChatFrameBackground]],
									edgeFile = [[Interface\AddOns\BigInputBox\media\rounded-backdrop-small.tga]], 
									edgeSize = 24,
									insets = { left = 24, right = 24, top = 24, bottom = 24 }
								});
								self:SetBackdropColor(0,0,0,.75);
								self:SetBackdropBorderColor(0,0,0,.75);
							</OnLoad>
						</Scripts>
					</Frame>
					<Frame name="$parentBorder" mixin="BigInputBoxBackdropTemplateMixin" parentKey="Border" frameStrata="FULLSCREEN" frameLevel="6">
						<Anchors>
							<Anchor point="TOPLEFT" x="-33" y="29"/>
							<Anchor point="BOTTOMRIGHT" x="33" y="-29"/>
						</Anchors>
						<Scripts>
							<OnLoad>
								self:SetBackdrop({ 
									edgeFile = [[Interface\AddOns\BigInputBox\media\rounded-border-small.tga]], 
									edgeSize = 24
								});
							</OnLoad>
						</Scripts>
					</Frame>
				</Frames>
				<Layers>
					<Layer level="OVERLAY" textureSubLevel="6">
						<FontString inherits="NumberFont_Outline_Large" justifyH="CENTER" justifyV="MIDDLE" parentKey="Label">
							<Size x="0" y="0"/>
							<Anchors>
								<Anchor point="BOTTOM" relativeKey="$parent" relativePoint="TOP" x="0" y="16"/>
							</Anchors>
							<Shadow>
								<Offset>
									<AbsDimension x="0" y="0"/>
								</Offset>
								<Color a="0" r="0" g="0" b="0"/>
							</Shadow>
						</FontString>
					</Layer>
				</Layers>
				<Scripts>
					<OnLoad>
						-- Various flags and methods for compatibility
						self.chatFrame = self:GetParent();
						self.chatFrame.AddMessage = function(frame, ...) 
							DEFAULT_CHAT_FRAME:AddMessage(...)
						end;
						self.chatLanguage = GetDefaultLanguage();
						self:SetAttribute("chatType", "SAY");
						self:SetAttribute("stickyType", "SAY");
						self:RegisterEvent("UPDATE_CHAT_COLOR");
						self.addSpaceToAutoComplete = true;
						self.addHighlightedText = true;

						local ChatEditAutoComplete = function(editBox, fullText, nameInfo, ambiguatedName)
							if hash_ChatTypeInfoList[string.upper(editBox.command)] == "SMART_WHISPER" then
								if nameInfo.bnetID ~= nil and nameInfo.bnetID ~= 0 then
									editBox:SetAttribute("tellTarget", nameInfo.name);
									editBox:SetAttribute("chatType", "BN_WHISPER");
								else
									editBox:SetAttribute("tellTarget", ambiguatedName);
									editBox:SetAttribute("chatType", "WHISPER");
								end
								editBox:SetText("");
								ChatEdit_UpdateHeader(editBox);
								return true;
							end
							return false;
						end
						AutoCompleteEditBox_SetCustomAutoCompleteFunction(self, ChatEditAutoComplete);

						self:HookScript("OnEnterPressed", function(self) 
							self.enterPressed = true;
							self:ClearFocus();
							self:GetParent():Hide();
						end)

						-- Fix the label font.
						self.Label:SetFont(self.Label:GetFont(), 18, "THINOUTLINE");

						-- Disable some Blizzard layers we don't need.
						self:DisableDrawLayer("BACKGROUND");
						self:DisableDrawLayer("BORDER");
						self:SetTextInsets(0,0,0,0);
						self.SetTextInsets = function() end

						for _,item in ipairs({ "focusLeft", "focusRight", "focusMid" }) do
							if (self[item]) then 
								self[item]:SetAlpha(0); 
							end
						end

						for _,item in ipairs({ "backdrop", "header", "headerSuffix", "NewcomerHint" }) do
							if (self[item]) then 
								self[item]:SetParent(self:GetParent().uiHider);
							end
						end
					</OnLoad>
					<OnEditFocusGained>
						self:Raise(); 
						self:SetAlpha(1); 
						-- Setting this is needed
						-- for items to be linked to the chat.
						ACTIVE_CHAT_EDIT_BOX = self; -- taint?
					</OnEditFocusGained>
					<OnEditFocusLost>
						if (not self.escapePressed) then
							self.lostFocus = true;
						end
						self:GetParent():Hide();
					</OnEditFocusLost>
					<OnEscapePressed>
						self.escapePressed = true; 
						self:GetParent():Hide();
					</OnEscapePressed>
					<OnUpdate>
					</OnUpdate>
					<OnHide>
						-- The order of events: Esc pressed > Focus lost > Hiding
						local reset = (self.escapePressed or self.enterPressed) and (not self.lostFocus)
						if (reset) then
							self:SetText("");
						end
						-- Clear these before the next time.
						self.escapePressed = nil;
						self.enterPressed = nil;
						self.lostFocus = nil;
						-- Make sure the other chat boxes don't
						-- get focus when ours is hidden.
						ACTIVE_CHAT_EDIT_BOX = nil -- taint?
						local alpha = 0;
						if (SELECTED_CHAT_FRAME) then
							for index,tex in pairs(CHAT_FRAME_TEXTURES) do
								if (not string.find(tex, "Tab")) then
									local object = _G[SELECTED_CHAT_FRAME:GetName()..tex]
									if (object:IsShown()) then
										UIFrameFadeRemoveFrame(object);
										object:SetAlpha(alpha);
									end
								end
							end
						end
						-- reset chat type to avoid being stuck at whisper targets.
						if (reset) then
							ChatEdit_ResetChatTypeToSticky(self);
							ChatEdit_ResetChatType(self);
						end
					</OnHide>
				</Scripts>
				<FontString inherits="NumberFont_Outline_Large" justifyH="CENTER" justifyV="MIDDLE">
					<Shadow>
						<Offset>
							<AbsDimension x="0" y="0"/>
						</Offset>
						<Color a="0" r="0" g="0" b="0"/>
					</Shadow>
				</FontString>
			</EditBox>
			<Frame name="$parentMoveButton" parentKey="MoveButton">
				<Scripts>
					<OnLoad>
						self:EnableMouse(true);
						self:RegisterForDrag("LeftButton");
						self:SetAllPoints(self:GetParent().editBox.Label);
					</OnLoad>
					<OnMouseUp>
						if (IsShiftKeyDown()) then
							self:GetParent():ClearAllPoints();
							self:GetParent():SetPoint("BOTTOM", 0, 330);

							local point, offsetX, offsetY = self:GetParent().editBox:GetParsedPosition();
							BigInputBox_DB.point = point;
							BigInputBox_DB.offsetX = offsetX;
							BigInputBox_DB.offsetY = offsetY;
						end
					</OnMouseUp>
					<OnDragStart>
						self:GetParent():SetMovable(true);
						self:GetParent():SetUserPlaced(true);
						self:GetParent():StartMoving();
					</OnDragStart>
					<OnDragStop>
						self:GetParent():StopMovingOrSizing();

						-- Save the position, call lua callbacks to store and calculate.
						local point, offsetX, offsetY = self:GetParent().editBox:GetParsedPosition();
						BigInputBox_DB.point = point;
						BigInputBox_DB.offsetX = offsetX;
						BigInputBox_DB.offsetY = offsetY;

						self:GetParent():SetUserPlaced(false);
						self:GetParent():SetMovable(false);
					</OnDragStop>
				</Scripts>
			</Frame>
		</Frames>
	</Frame>

	<Button name="BigInputBoxToggleButton" inherits="SecureActionButtonTemplate" parent="UIParent">
		<Scripts>
			<OnClick>
				local frame = BigInputBox;
				if (frame.editBox:IsVisible()) then
					frame:Hide();
					frame.editBox:Hide();
					frame.editBox:ClearFocus();
				else
					frame:Show();
					frame.editBox:Show();
					frame.editBox:SetFocus();
				end
			</OnClick>
		</Scripts>
	</Button>

	<Button name="BigInputBoxReplyButton" inherits="SecureActionButtonTemplate" parent="UIParent">
		<Scripts>
			<OnClick>
				local frame = BigInputBox;
				local lastTell, lastTellType = ChatEdit_GetLastTellTarget();
				if (lastTell) then
					frame.editBox:SetAttribute("chatType", lastTellType);
					frame.editBox:SetAttribute("tellTarget", lastTell);
				end
				frame:Show();
				frame.editBox:Show();
				frame.editBox:SetFocus();
			</OnClick>
		</Scripts>
	</Button>

	<Button name="BigInputBoxRewhisperButton" inherits="SecureActionButtonTemplate" parent="UIParent">
		<Scripts>
			<OnClick>
				local frame = BigInputBox;
				local lastTold, lastToldType = ChatEdit_GetLastToldTarget();
				if (lastTold) then
					frame.editBox:SetAttribute("chatType", lastToldType);
					frame.editBox:SetAttribute("tellTarget", lastTold);
				end
				frame:Show();
				frame.editBox:Show();
				frame.editBox:SetFocus();
			</OnClick>
		</Scripts>
	</Button>

</Ui>